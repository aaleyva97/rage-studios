<p-toast />
<p-confirmDialog />

<div class="admin-dashboard">
  <div class="dashboard-header mb-6">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">Panel de Administración</h1>
    <p class="text-gray-600">Bienvenido, {{ getUserDisplayName() }}</p>
  </div>
  
  <!-- Error state -->
  @if (error()) {
    <p-message 
      severity="error" 
      text="{{ error() }}" 
      class="mb-6">
      <ng-template pTemplate="content">
        <div class="flex items-center gap-3">
          <i class="pi pi-exclamation-triangle"></i>
          <div>
            <p>{{ error() }}</p>
            <button 
              class="text-sm underline text-red-600 hover:text-red-800 mt-1"
              (click)="retryLoadStats()">
              Intentar de nuevo
            </button>
          </div>
        </div>
      </ng-template>
    </p-message>
  }
  
  <!-- Loading state -->
  @if (loading()) {
    <div class="flex justify-center items-center py-12">
      <p-progressSpinner 
        [style]="{'width': '50px', 'height': '50px'}" 
        strokeWidth="4">
      </p-progressSpinner>
    </div>
  } @else {
    <!-- Estadísticas principales -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <p-card class="stats-card">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Total Reservas</p>
            <p class="text-2xl font-bold text-blue-600">{{ adminStats().totalReservas }}</p>
          </div>
          <i class="pi pi-calendar text-blue-500 text-2xl"></i>
        </div>
      </p-card>
      
      <p-card class="stats-card">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Reservas Hoy</p>
            <p class="text-2xl font-bold text-green-600">{{ adminStats().reservasHoy }}</p>
          </div>
          <i class="pi pi-clock text-green-500 text-2xl"></i>
        </div>
      </p-card>
      
      <p-card class="stats-card">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Usuarios Activos</p>
            <p class="text-2xl font-bold text-purple-600">{{ adminStats().usuariosActivos }}</p>
          </div>
          <i class="pi pi-users text-purple-500 text-2xl"></i>
        </div>
      </p-card>
      
      <p-card class="stats-card">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Créditos Totales</p>
            <p class="text-2xl font-bold text-orange-600">{{ adminStats().creditosTotales }}</p>
          </div>
          <i class="pi pi-wallet text-orange-500 text-2xl"></i>
        </div>
      </p-card>
    </div>
    
    <!-- Acciones rápidas -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <!-- Gestionar Reservas - ACTIVA -->
      <p-card 
        class="action-card cursor-pointer"
        (click)="navigateToSection('reservas')">
        <div class="text-center">
          <i class="pi pi-calendar text-4xl text-blue-500 mb-4"></i>
          <h3 class="text-lg font-semibold mb-2">Gestionar Reservas</h3>
          <p class="text-gray-600 text-sm">Ver y administrar todas las reservas</p>
        </div>
      </p-card>
      
      <!-- Gestionar Créditos - ACTIVA -->
      <p-card 
        class="action-card cursor-pointer"
        (click)="navigateToSection('credits')">
        <div class="text-center">
          <i class="pi pi-wallet text-4xl text-blue-500 mb-4"></i>
          <h3 class="text-lg font-semibold mb-2">Gestionar Créditos</h3>
          <p class="text-gray-600 text-sm">Administrar créditos de usuarios</p>
        </div>
      </p-card>
      
      <!-- Gestionar Sesiones - ACTIVA -->
      <p-card 
        class="action-card cursor-pointer"
        (click)="navigateToSection('sessions')">
        <div class="text-center">
          <i class="pi pi-clock text-4xl text-blue-500 mb-4"></i>
          <h3 class="text-lg font-semibold mb-2">Gestionar Sesiones</h3>
          <p class="text-gray-600 text-sm">Configurar horarios y sesiones</p>
        </div>
      </p-card>
      
      <!-- Gestionar Coaches - ACTIVA -->
      <p-card 
        class="action-card cursor-pointer"
        (click)="navigateToSection('coaches')">
        <div class="text-center">
          <i class="pi pi-users text-4xl text-blue-500 mb-4"></i>
          <h3 class="text-lg font-semibold mb-2">Gestionar Coaches</h3>
          <p class="text-gray-600 text-sm">Administrar información de coaches</p>
        </div>
      </p-card>
    </div>
    
    <!-- Segunda fila de acciones -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-6">
      <!-- Gestionar Horarios -->
      <p-card 
        class="action-card cursor-pointer"
        (click)="navigateToSection('horarios')">
        <div class="text-center">
          <i class="pi pi-calendar-clock text-4xl text-blue-500 mb-4"></i>
          <h3 class="text-lg font-semibold mb-2">Gestionar Horarios</h3>
          <p class="text-gray-600 text-sm">Configurar horarios y coaches por día</p>
        </div>
      </p-card>
      
      <!-- Sistema de Reservas -->
      <p-card class="action-card">
        <div class="text-center">
          <i class="pi pi-calendar-clock text-4xl text-blue-500 mb-4"></i>
          <h3 class="text-lg font-semibold mb-2">Sistema de Reservas</h3>
          <p class="text-gray-600 text-sm mb-4">
            Configuración de reservas
            @if (bookingsScheduleMode === 'scheduled') {
              <span class="text-xs text-blue-600 font-medium">(Programado)</span>
            }
          </p>

          <div class="flex flex-col items-center gap-3">
            <!-- Estado actual -->
            <div class="flex items-center gap-2 mb-2">
              <i class="pi text-lg" [class.pi-check-circle]="bookingsEnabled" [class.pi-times-circle]="!bookingsEnabled" [class.text-green-600]="bookingsEnabled" [class.text-red-600]="!bookingsEnabled"></i>
              <span class="text-sm font-medium" [class.text-red-600]="!bookingsEnabled" [class.text-green-600]="bookingsEnabled">
                {{ bookingsEnabled ? 'Habilitadas' : 'Deshabilitadas' }}
              </span>
            </div>

            <!-- Información de programación -->
            @if (bookingsScheduleMode === 'scheduled' && (bookingsCloseDate || bookingsOpenDate)) {
              <div class="text-xs text-gray-600 space-y-1 max-w-xs">
                @if (bookingsCloseDate) {
                  <div class="flex items-center gap-2 justify-center">
                    <i class="pi pi-lock text-red-500"></i>
                    <span><strong>Cierre:</strong> {{ formatDateTime(bookingsCloseDate) }}</span>
                  </div>
                }
                @if (bookingsOpenDate) {
                  <div class="flex items-center gap-2 justify-center">
                    <i class="pi pi-unlock text-green-500"></i>
                    <span><strong>Apertura:</strong> {{ formatDateTime(bookingsOpenDate) }}</span>
                  </div>
                }
              </div>
            }

            <!-- Botón de configuración -->
            <p-button
              label="Configurar"
              icon="pi pi-cog"
              severity="primary"
              size="small"
              (onClick)="openScheduleDialog()"
              [disabled]="settingsLoading"
              styleClass="w-full max-w-xs"
            />

            @if (settingsLoading) {
              <div class="flex items-center gap-2 text-xs text-gray-500">
                <i class="pi pi-spin pi-spinner"></i>
                <span>Actualizando...</span>
              </div>
            }
          </div>
        </div>
      </p-card>

      <!-- Política de Cancelación -->
      <p-card class="action-card">
        <div class="text-center">
          <i class="pi pi-clock text-4xl text-blue-500 mb-4"></i>
          <h3 class="text-lg font-semibold mb-2">Política de Cancelación</h3>
          <p class="text-gray-600 text-sm mb-4">Horas mínimas para cancelar</p>

          <div class="flex flex-col items-center gap-4 px-4">
            <div class="w-full max-w-[200px]">
              <p-inputNumber
                [ngModel]="tempCancellationHours()"
                (ngModelChange)="tempCancellationHours.set($event)"
                [min]="0"
                [max]="72"
                [showButtons]="true"
                [step]="1"
                buttonLayout="vertical"
                inputId="cancellation-hours"
                [disabled]="settingsLoading"
                suffix=" hrs"
                styleClass="w-full"
                inputStyleClass="text-center">
              </p-inputNumber>
            </div>

            <p-button
              label="Aplicar"
              icon="pi pi-check"
              severity="success"
              size="small"
              (onClick)="updateCancellationHours()"
              [disabled]="settingsLoading || tempCancellationHours() === cancellationHoursBefore"
              styleClass="w-full max-w-[200px]">
            </p-button>

            <div class="text-xs text-gray-500 mt-1">
              <i class="pi pi-info-circle mr-1"></i>
              Actual: {{ cancellationHoursBefore }} hora{{ cancellationHoursBefore !== 1 ? 's' : '' }}
            </div>

            @if (settingsLoading) {
              <div class="flex items-center gap-2 text-xs text-gray-500">
                <i class="pi pi-spin pi-spinner"></i>
                <span>Actualizando...</span>
              </div>
            }
          </div>
        </div>
      </p-card>
    </div>
  }
</div>

<!-- Diálogo de Configuración de Programación de Reservas -->
<app-booking-schedule-dialog
  [visible]="showScheduleDialog()"
  (visibleChange)="showScheduleDialog.set($event)"
  (scheduleUpdated)="onScheduleUpdated()"
/>