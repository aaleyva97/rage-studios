<p-dialog
  [visible]="visible()"
  (visibleChange)="onHide()"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="w-full max-w-3xl"
  header="Configuración de Reservas"
>
  <div class="flex flex-col gap-6">

    <!-- Checkbox de Control Manual -->
    <section class="border-b pb-4">
      <div class="flex items-center gap-3">
        <p-checkbox
          [(ngModel)]="isManualControl"
          [binary]="true"
          inputId="manualControl"
          (onChange)="onManualControlChange()"
        />
        <label for="manualControl" class="text-base font-semibold text-gray-900 cursor-pointer">
          Control Manual
        </label>
      </div>
      <p class="text-sm text-gray-600 mt-2 ml-9">
        @if (isManualControl()) {
          Activa o desactiva las reservas manualmente con el switch
        } @else {
          Programa fechas automáticas de cierre y apertura de reservas
        }
      </p>
    </section>

    <!-- VISTA MODO MANUAL -->
    @if (isManualControl()) {
      <section>
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Estado de Reservas</h3>

        <div class="flex items-center justify-center gap-4 p-6 bg-gray-50 rounded-lg border">
          <div class="flex flex-col items-center gap-2">
            <span class="text-sm font-medium text-gray-700">
              {{ bookingsEnabled() ? 'Habilitadas' : 'Deshabilitadas' }}
            </span>
            <p-toggleSwitch
              [(ngModel)]="bookingsEnabled"
              styleClass="scale-125"
            />
          </div>
        </div>

        <p-message
          severity="info"
          text="Usa el switch para habilitar o deshabilitar las reservas manualmente. Los cambios se aplicarán inmediatamente al guardar."
          styleClass="w-full mt-4"
        />
      </section>
    }

    <!-- VISTA MODO PROGRAMADO -->
    @if (!isManualControl()) {
      <section>
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Programación de Fechas</h3>

        <!-- Botón Abrir Ahora si está cerrado programadamente -->
        @if (isScheduledAndClosed) {
          <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div class="flex items-center justify-between gap-4">
              <div class="flex items-center gap-3">
                <i class="pi pi-exclamation-triangle text-2xl text-yellow-600"></i>
                <div>
                  <p class="font-medium text-yellow-900">Reservas cerradas por programación</p>
                  <p class="text-sm text-yellow-800 mt-1">
                    ¿Necesitas abrirlas ahora? Cancela la programación y habilítalas manualmente
                  </p>
                </div>
              </div>
              <p-button
                label="Abrir Ahora"
                icon="pi pi-unlock"
                severity="success"
                (onClick)="openNow()"
                [loading]="isSaving()"
                [disabled]="isSaving()"
              />
            </div>
          </div>
        }

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Fecha de Cierre -->
          <div class="flex flex-col gap-2">
            <label class="font-medium text-gray-700">
              Fecha de Cierre
              <span class="text-red-500">*</span>
            </label>
            <p-datepicker
             appendTo="body"
              [(ngModel)]="closeDateTime"
              [showTime]="true"
              hourFormat="12"
              [minDate]="minDate"
              dateFormat="dd/mm/yy"
              placeholder="Seleccionar fecha y hora"
              [showIcon]="true"
              styleClass="w-full"
            />
            <small class="text-gray-600">
              Las reservas se deshabilitarán automáticamente en esta fecha.
            </small>
            @if (closeDateTime()) {
              <p class="text-sm text-gray-800 font-medium">
                Cierre programado: {{ formatDateTime(closeDateTime()) }}
              </p>
            }
          </div>

          <!-- Fecha de Apertura -->
          <div class="flex flex-col gap-2">
            <label class="font-medium text-gray-700">
              Fecha de Apertura
              <span class="text-red-500">*</span>
            </label>
            <p-datepicker
               appendTo="body"
              [(ngModel)]="openDateTime"
              [showTime]="true"
              hourFormat="12"
              [minDate]="minDate"
              dateFormat="dd/mm/yy"
              placeholder="Seleccionar fecha y hora"
              [showIcon]="true"
              styleClass="w-full"
            />
            <small class="text-gray-600">
              Las reservas se habilitarán automáticamente en esta fecha.
            </small>
            @if (openDateTime()) {
              <p class="text-sm text-gray-800 font-medium">
                Apertura programada: {{ formatDateTime(openDateTime()) }}
              </p>
            }
          </div>
        </div>

        <!-- Información adicional -->
        <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
          <p class="text-sm text-blue-900">
            <strong>Nota:</strong> El sistema verificará automáticamente las fechas cuando un usuario intente hacer una reserva.
            Entre la fecha de cierre y apertura, las reservas estarán deshabilitadas.
          </p>
        </div>
      </section>
    }

    <!-- Mensaje de Error -->
    @if (errorMessage()) {
      <p-message
        severity="error"
        [text]="errorMessage()"
        styleClass="w-full"
      />
    }
  </div>

  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-3">
      <p-button
        label="Cancelar"
        severity="secondary"
        (onClick)="onHide()"
        [disabled]="isSaving()"
      />
      <p-button
        label="Guardar"
        severity="primary"
        (onClick)="onSave()"
        [loading]="isSaving()"
        [disabled]="isSaving()"
      />
    </div>
  </ng-template>
</p-dialog>
